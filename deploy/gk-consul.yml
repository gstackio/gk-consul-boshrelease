---
name: ((deployment_name))

instance_groups:
  - name: consul
    instances: 3
    azs: [ z1 ]
    jobs:
      - name: consul
        release: gk-consul
        provides:
          consul: { as: consul-servers }
          consul-address: { as: consul-server-address }
        consumes:
          consul-servers: { from: consul-servers }
        properties:
          server: true
          encrypt: ((consul_encrypt_key))
          tls:
            cert: ((consul_agent_tls))
      - name: bpm
        release: bpm
    persistent_disk_type: default
    stemcell: default
    vm_type: default
    networks:
      - name: ((network_name))

  - name: consul-ui
    instances: 2
    azs: [ z1 ]
    jobs:
      - name: consul
        release: gk-consul
        provides:
          consul-address: { as: consul-ui-address }
        consumes:
          consul-servers: { from: consul-servers }
        properties:
          server: true
          ui:
            enabled: true
          encrypt: ((consul_encrypt_key))
          tls:
            cert: ((consul_ui_tls))
      - name: bpm
        release: bpm
    persistent_disk_type: default
    stemcell: default
    vm_type: default
    networks:
      - name: ((network_name))

variables:
  - name: consul_encrypt_key
    type: password
    options:
      length: 50
  - name: consul_ca
    type: certificate
    options:
      is_ca: true
      common_name: Consul CA
    update_mode: converge
  - name: consul_agent_tls
    type: certificate
    update_mode: converge
    options:
      extended_key_usage: [ server_auth, client_auth ]
      ca: consul_ca
      common_name: consul.((network_name)).((deployment_name)).bosh
      alternative_names:
        - "*.consul.((network_name)).((deployment_name)).bosh"
        - "127.0.0.1"
        - "server.dc1.consul"
    consumes:
      alternative_name: { from: consul-server-address }
    update_mode: converge
  - name: consul_ui_tls
    type: certificate
    update_mode: converge
    options:
      extended_key_usage: [ server_auth, client_auth ]
      ca: consul_ca
      common_name: consul-ui.((network_name)).((deployment_name)).bosh
      alternative_names:
        - "*.consul-ui.((network_name)).((deployment_name)).bosh"
        - "127.0.0.1"
        - "server.dc1.consul"
    consumes:
      alternative_name: { from: consul-ui-address }
    update_mode: converge

features:
  use_dns_addresses: true

stemcells:
  - alias: default
    os: ubuntu-xenial
    version: latest

update:
  # NOTE: with 5 nodes, we can cope with 2 nodes being down at the same time,
  # so 'serial: false' is OK. But in production, 'serial: true' should be
  # considered for more safety.
  serial: false
  canaries: 1
  canary_watch_time: 1000-60000
  max_in_flight: 1
  update_watch_time: 1000-60000

releases:
- name: gk-consul
  sha1: 1146988e1955468729620040a2cee023b4a241ac
  stemcell:
    os: ubuntu-xenial
    version: "621.29"
  url: https://s3.eu-west-3.amazonaws.com/gk-consul-boshrelease/compiled-releases/gk-consul/gk-consul-1.1.0-ubuntu-xenial-621.29-20191210-231659-733617686-20191210231702.tgz
  version: 1.1.0
- name: bpm
  sha1: e7d474c3a205fa4438ea5a60d3b59479939163aa
  url: https://bosh.io/d/github.com/cloudfoundry/bpm-release?v=1.1.7
  version: 1.1.7
